<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- This meta tag is crucial for mobile responsiveness -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Park Save</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font and base styles */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        /* Style for the snap button's outer ring */
        #snap-button {
            box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col items-center min-h-screen p-4 box-border">

    <!-- Header Section -->
    <header class="text-center w-full">
        <h1 class="text-4xl font-bold text-cyan-400">
            <span class="text-5xl align-middle">ðŸš—</span> Park Save
        </h1>
        <p class="text-gray-500 mt-2">Save a temporary photo of your parking spot.</p>
    </header>

    <!-- Content Wrapper -->
        <div class="flex flex-col items-center w-full max-w-lg">
        <!-- Photo Display Area -->
                <main id="photo-container" class="w-full bg-gray-800 border border-gray-700 rounded-xl overflow-hidden mb-4 flex flex-grow items-center justify-center max-h-[75vh]">
            <img id="saved-photo" class="w-full h-full object-contain hidden" alt="Your saved parking spot photo">
            <p id="placeholder-text" class="p-8 text-center text-gray-500">No photo saved yet. Take one below!</p>
        </main>

        <!-- Main Action Button -->
        <footer class="w-full">
            <button id="action-button" class="bg-cyan-500 hover:bg-cyan-600 transition-colors text-white text-lg font-bold w-full py-4 px-8 rounded-xl shadow-lg">
                Take / Replace Picture
            </button>
        </footer>
    </div>

    <!-- Fullscreen Camera View (Initially Hidden) -->
    <div id="camera-view" class="fixed inset-0 bg-black z-50 hidden flex-col justify-end items-center">
        <!-- The video element will fill the screen -->
        <video id="video-element" class="absolute top-0 left-0 w-full h-full object-cover" autoplay playsinline></video>
        
        <!-- Snap Button -->
        <button id="snap-button" class="relative w-16 h-16 bg-white rounded-full cursor-pointer mb-12 transition"></button>
        
        <!-- Hidden canvas for processing the image -->
        <canvas id="canvas-element" class="hidden"></canvas>
    </div>

    <script>
        // --- DOM Element Selection ---
        const savedPhoto = document.getElementById('saved-photo');
        const placeholderText = document.getElementById('placeholder-text');
        const actionButton = document.getElementById('action-button');
        const cameraView = document.getElementById('camera-view');
        const video = document.getElementById('video-element');
        const snapButton = document.getElementById('snap-button');
        const canvas = document.getElementById('canvas-element');
        const context = canvas.getContext('2d');

        // --- Constants and State ---
        const STORAGE_KEY = 'park-save-photo';
        let currentStream = null;

        // --- Core Functions ---

        /**
         * Displays the provided image data in the main view.
         * @param {string} imageDataUrl - The Base64 data URL of the image.
         */
        function showPhoto(imageDataUrl) {
            savedPhoto.src = imageDataUrl;
            savedPhoto.classList.remove('hidden');
            placeholderText.classList.add('hidden');
        }

        /**
         * Starts the device camera and displays the feed.
         */
        async function startCamera() {
            // Ensure we can access media devices
            if (!('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices)) {
                alert('Camera not available on this device.');
                return;
            }

            try {
                // Define constraints to prefer the rear camera
                const constraints = {
                    video: {
                        facingMode: 'environment' // 'environment' for rear, 'user' for front
                    }
                };
                
                // Request camera access
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                
                // Show the camera view
                cameraView.style.display = 'flex'; // Use flex to enable justify/align
            } catch (error) {
                console.error("Error accessing camera: ", error);
                alert("Could not access the camera. Please ensure you've given permission in your browser settings.");
                stopCamera(); // Clean up if something went wrong
            }
        }

        /**
         * Stops the camera stream and hides the camera view.
         */
        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            cameraView.style.display = 'none';
        }

        /**
         * Captures a photo from the video stream, saves it, and displays it.
         */
        function snapPicture() {
            // Set the canvas dimensions to match the video's intrinsic size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw the current video frame onto the hidden canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convert the canvas content to a JPEG data URL. 0.9 is high quality.
            const imageDataUrl = canvas.toDataURL('image/jpeg', 0.9);

            // Save the new image to localStorage, overwriting the old one
            try {
                localStorage.setItem(STORAGE_KEY, imageDataUrl);
            } catch (e) {
                console.error("Storage failed: " + e);
                alert("Could not save the photo. Your browser's storage might be full.");
            }

            // Display the newly captured photo
            showPhoto(imageDataUrl);

            // Turn off the camera and hide the view
            stopCamera();
        }

        // --- Event Listeners ---

        /**
         * On page load, check for a previously saved photo in localStorage.
         */
        window.addEventListener('load', () => {
            const savedImage = localStorage.getItem(STORAGE_KEY);
            if (savedImage) {
                showPhoto(savedImage);
            }
        });

        // Add click listener to the main button to start the camera.
        actionButton.addEventListener('click', startCamera);

        // Add click listener to the snap button to capture the photo.
        snapButton.addEventListener('click', snapPicture);

    </script>
</body>
</html>
